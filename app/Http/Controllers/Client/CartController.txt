<?php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Models\CartItem;
use App\Models\Product;
use App\Models\ProductVariant;
use App\Models\StockItem;
use App\Models\Coupon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class CartController extends Controller
{
    /**
     * Hiển thị giỏ hàng
     */
    public function index()
    {
        $cartItems = CartItem::with(['product.variants.stockItems', 'variant.stockItems'])
            ->where('user_id', Auth::id())
            ->get();

        // Tính toán từ product
        $subtotal = $cartItems->sum(function ($item) {
            $price = $item->product->sale_price ?? $item->product->price;
            return $price * $item->quantity;
        });

        $discount = session('cart_discount', 0);
        $shipping = 30000;
        $total = $subtotal - $discount + $shipping;

        return view('client.cart.index', compact(
            'cartItems',
            'subtotal',
            'discount',
            'shipping',
            'total'
        ));
    }

    /**
     * Lấy tồn kho từ stock_items
     */
    private function getStock($productId, $variantId = null)
    {
        if ($variantId) {
            // Lấy tồn kho của variant cụ thể
            return StockItem::where('variant_id', $variantId)
                ->sum('quantity');
        }

        // Lấy tổng tồn kho của tất cả variants thuộc product
        $variantIds = ProductVariant::where('product_id', $productId)->pluck('id');

        return StockItem::whereIn('variant_id', $variantIds)
            ->sum('quantity');
    }

    /**
     * Thêm sản phẩm vào giỏ hàng
     */
    public function add(Request $request, $productId)
    {
        try {
            $request->validate([
                'quantity' => 'nullable|integer|min:1|max:99',
                'variant_id' => 'nullable|exists:variants,id'
            ]);

            $product = Product::findOrFail($productId);
            $quantity = $request->input('quantity', 1); // Mặc định = 1
            $variantId = $request->input('variant_id');

            // Kiểm tra tồn kho từ stock_items
            $availableStock = $this->getStock($productId, $variantId);

            if ($availableStock < $quantity) {
                return response()->json([
                    'success' => false,
                    'message' => 'Sản phẩm không đủ số lượng trong kho (còn ' . $availableStock . ')'
                ], 400);
            }

            // Kiểm tra xem sản phẩm đã có trong giỏ chưa
            $existingItem = CartItem::where('user_id', Auth::id())
                ->where('product_id', $productId)
                ->when($variantId, fn($q) => $q->where('variant_id', $variantId))
                ->when(!$variantId, fn($q) => $q->whereNull('variant_id'))
                ->first();

            if ($existingItem) {
                // Cập nhật số lượng
                $newQuantity = $existingItem->quantity + $quantity;

                if ($newQuantity > $availableStock) {
                    return response()->json([
                        'success' => false,
                        'message' => 'Số lượng vượt quá tồn kho (còn ' . $availableStock . ')'
                    ], 400);
                }

                $existingItem->update(['quantity' => $newQuantity]);

                return response()->json([
                    'success' => true,
                    'message' => 'Đã cập nhật số lượng sản phẩm trong giỏ hàng',
                    'cartCount' => CartItem::where('user_id', Auth::id())->sum('quantity')
                ]);
            }

            // Tạo mới cart item
            CartItem::create([
                'user_id' => Auth::id(),
                'product_id' => $productId,
                'variant_id' => $variantId,
                'quantity' => $quantity
            ]);

            return response()->json([
                'success' => true,
                'message' => 'Đã thêm sản phẩm vào giỏ hàng',
                'cartCount' => CartItem::where('user_id', Auth::id())->sum('quantity')
            ]);

        } catch (\Exception $e) {
            Log::error('Add to cart error: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Có lỗi xảy ra: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Cập nhật số lượng
     */
    public function update(Request $request, $cartItemId)
    {
        try {
            $request->validate([
                'quantity' => 'required|integer|min:1|max:99'
            ]);

            $cartItem = CartItem::where('user_id', Auth::id())
                ->where('id', $cartItemId)
                ->with('product')
                ->firstOrFail();

            $quantity = $request->quantity;

            // Kiểm tra tồn kho từ stock_items
            $availableStock = $this->getStock($cartItem->product_id, $cartItem->variant_id);

            if ($quantity > $availableStock) {
                return response()->json([
                    'success' => false,
                    'message' => 'Số lượng vượt quá tồn kho (còn ' . $availableStock . ')'
                ], 400);
            }

            $cartItem->update(['quantity' => $quantity]);

            $price = $cartItem->product->sale_price ?? $cartItem->product->price;

            return response()->json([
                'success' => true,
                'message' => 'Đã cập nhật số lượng',
                'subtotal' => number_format($price * $quantity) . '₫',
                'cartCount' => CartItem::where('user_id', Auth::id())->sum('quantity')
            ]);

        } catch (\Exception $e) {
            Log::error('Update cart error: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Có lỗi xảy ra: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Xóa sản phẩm
     */
    public function remove($cartItemId)
    {
        try {
            $cartItem = CartItem::where('user_id', Auth::id())
                ->where('id', $cartItemId)
                ->firstOrFail();

            $cartItem->delete();

            return response()->json([
                'success' => true,
                'message' => 'Đã xóa sản phẩm khỏi giỏ hàng',
                'cartCount' => CartItem::where('user_id', Auth::id())->sum('quantity')
            ]);

        } catch (\Exception $e) {
            Log::error('Remove cart item error: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Có lỗi xảy ra khi xóa sản phẩm'
            ], 500);
        }
    }

    /**
     * Áp dụng mã giảm giá
     */
    public function applyCoupon(Request $request)
    {
        $request->validate(['code' => 'required|string']);

        $coupon = Coupon::where('code', strtoupper($request->code))
            ->where('is_active', true)
            ->where('expires_at', '>', now())
            ->first();

        if (!$coupon) {
            return response()->json([
                'success' => false,
                'message' => 'Mã giảm giá không hợp lệ hoặc đã hết hạn'
            ], 400);
        }

        // Tính tổng từ product
        $cartItems = CartItem::with('product')->where('user_id', Auth::id())->get();
        $cartTotal = $cartItems->sum(function ($item) {
            $price = $item->product->sale_price ?? $item->product->price;
            return $price * $item->quantity;
        });

        if ($cartTotal < $coupon->min_order_value) {
            return response()->json([
                'success' => false,
                'message' => 'Đơn hàng chưa đạt giá trị tối thiểu ' . number_format($coupon->min_order_value) . '₫'
            ], 400);
        }

        $discount = $coupon->type === 'percent'
            ? min($cartTotal * $coupon->value / 100, $coupon->max_discount ?? PHP_INT_MAX)
            : $coupon->value;

        session([
            'cart_discount' => $discount,
            'coupon_code' => $coupon->code
        ]);

        return response()->json([
            'success' => true,
            'discount' => $discount,
            'message' => 'Áp dụng mã giảm giá thành công! Giảm ' . number_format($discount) . '₫'
        ]);
    }

    /**
     * Xóa toàn bộ giỏ hàng
     */
    public function clear()
    {
        CartItem::where('user_id', Auth::id())->delete();
        session()->forget(['cart_discount', 'coupon_code']);

        return response()->json([
            'success' => true,
            'message' => 'Đã xóa tất cả sản phẩm trong giỏ hàng'
        ]);
    }
}


// namespace App\Http\Controllers\Client;

// use App\Http\Controllers\Controller;
// use App\Models\CartItem;
// use App\Models\Product;
// use App\Models\ProductVariant;
// use App\Models\StockItem;
// use Illuminate\Http\Request;
// use Illuminate\Support\Facades\Auth;
// use Illuminate\Support\Facades\Log;

// class CartController extends Controller
// {
//     /**
//      * Hiển thị giỏ hàng
//      */
//     public function index()
//     {
//         $cartItems = CartItem::with([
//             'product.images',
//             'product.category',
//             'variant.stockItems'
//         ])
//             ->where('user_id', Auth::id())
//             ->get();

//         // Tính tổng
//         $subtotal = $cartItems->sum(function ($item) {
//             return $this->getItemPrice($item) * $item->quantity;
//         });

//         $discount = session('cart_discount', 0);
//         $shipping = 30000;
//         $total = $subtotal - $discount + $shipping;

//         return view('client.cart.index', compact(
//             'cartItems',
//             'subtotal',
//             'discount',
//             'shipping',
//             'total'
//         ));
//     }

//     /**
//      * Lấy giá của item (product hoặc variant)
//      */
//     private function getItemPrice($item)
//     {
//         if ($item->variant_id && $item->variant) {
//             return $item->variant->sale_price ?? $item->variant->price;
//         }

//         return $item->product->sale_price ?? $item->product->price;
//     }

//     /**
//      * Lấy tồn kho
//      */
//     private function getStock($productId, $variantId = null)
//     {
//         if ($variantId) {
//             return StockItem::where('variant_id', $variantId)->sum('quantity');
//         }

//         $variantIds = ProductVariant::where('product_id', $productId)->pluck('id');
//         return StockItem::whereIn('variant_id', $variantIds)->sum('quantity');
//     }

//     /**
//      * Thêm sản phẩm vào giỏ (NHẬN PRODUCT ID)
//      */
//     public function add(Request $request, $productId) // $productId là số, không phải object
//     {
//         try {
//             $request->validate([
//                 'quantity' => 'nullable|integer|min:1|max:99',
//                 'variant_id' => 'nullable|exists:product_variants,id'
//             ]);

//             $product = Product::findOrFail($productId);
//             $quantity = $request->input('quantity', 1);
//             $variantId = $request->input('variant_id');

//             // Kiểm tra tồn kho
//             $availableStock = $this->getStock($productId, $variantId);

//             if ($availableStock < 1) {
//                 return response()->json([
//                     'success' => false,
//                     'message' => 'Sản phẩm hiện đã hết hàng'
//                 ], 400);
//             }

//             if ($availableStock < $quantity) {
//                 return response()->json([
//                     'success' => false,
//                     'message' => "Sản phẩm chỉ còn {$availableStock} sản phẩm"
//                 ], 400);
//             }

//             // Kiểm tra item đã có trong giỏ chưa
//             $existingItem = CartItem::where('user_id', Auth::id())
//                 ->where('product_id', $productId)
//                 ->when($variantId, fn($q) => $q->where('variant_id', $variantId))
//                 ->when(!$variantId, fn($q) => $q->whereNull('variant_id'))
//                 ->first();

//             if ($existingItem) {
//                 $newQuantity = $existingItem->quantity + $quantity;

//                 if ($newQuantity > $availableStock) {
//                     return response()->json([
//                         'success' => false,
//                         'message' => "Chỉ có thể thêm tối đa {$availableStock} sản phẩm"
//                     ], 400);
//                 }

//                 $existingItem->update(['quantity' => $newQuantity]);

//                 return response()->json([
//                     'success' => true,
//                     'message' => 'Đã cập nhật số lượng sản phẩm trong giỏ hàng',
//                     'cart_count' => CartItem::where('user_id', Auth::id())->sum('quantity')
//                 ]);
//             }

//             // Tạo mới cart item
//             CartItem::create([
//                 'user_id' => Auth::id(),
//                 'product_id' => $productId,
//                 'variant_id' => $variantId,
//                 'quantity' => $quantity
//             ]);

//             return response()->json([
//                 'success' => true,
//                 'message' => 'Đã thêm sản phẩm vào giỏ hàng',
//                 'cart_count' => CartItem::where('user_id', Auth::id())->sum('quantity')
//             ]);

//         } catch (\Exception $e) {
//             Log::error('Add to cart error: ' . $e->getMessage());

//             return response()->json([
//                 'success' => false,
//                 'message' => 'Có lỗi xảy ra: ' . $e->getMessage()
//             ], 500);
//         }
//     }

//     /**
//      * Cập nhật số lượng
//      */
//     public function update(Request $request, $cartItemId)
//     {
//         try {
//             $request->validate([
//                 'quantity' => 'required|integer|min:1|max:99'
//             ]);

//             $cartItem = CartItem::where('user_id', Auth::id())
//                 ->where('id', $cartItemId)
//                 ->with(['product', 'variant'])
//                 ->firstOrFail();

//             $quantity = $request->quantity;
//             $availableStock = $this->getStock($cartItem->product_id, $cartItem->variant_id);

//             if ($quantity > $availableStock) {
//                 return response()->json([
//                     'success' => false,
//                     'message' => "Chỉ còn {$availableStock} sản phẩm trong kho"
//                 ], 400);
//             }

//             $cartItem->update(['quantity' => $quantity]);

//             $price = $this->getItemPrice($cartItem);
//             $subtotal = $price * $quantity;

//             return response()->json([
//                 'success' => true,
//                 'message' => 'Đã cập nhật số lượng',
//                 'item_subtotal' => number_format($subtotal) . '₫',
//                 'cart_count' => CartItem::where('user_id', Auth::id())->sum('quantity')
//             ]);

//         } catch (\Exception $e) {
//             Log::error('Update cart error: ' . $e->getMessage());

//             return response()->json([
//                 'success' => false,
//                 'message' => 'Có lỗi xảy ra'
//             ], 500);
//         }
//     }

//     /**
//      * Xóa sản phẩm
//      */
//     public function remove($cartItemId)
//     {
//         try {
//             $cartItem = CartItem::where('user_id', Auth::id())
//                 ->where('id', $cartItemId)
//                 ->firstOrFail();

//             $cartItem->delete();

//             return response()->json([
//                 'success' => true,
//                 'message' => 'Đã xóa sản phẩm khỏi giỏ hàng',
//                 'cart_count' => CartItem::where('user_id', Auth::id())->sum('quantity')
//             ]);

//         } catch (\Exception $e) {
//             Log::error('Remove cart item error: ' . $e->getMessage());

//             return response()->json([
//                 'success' => false,
//                 'message' => 'Có lỗi xảy ra khi xóa sản phẩm'
//             ], 500);
//         }
//     }

//     /**
//      * Xóa toàn bộ giỏ hàng
//      */
//     public function clear()
//     {
//         CartItem::where('user_id', Auth::id())->delete();
//         session()->forget(['cart_discount', 'coupon_code']);

//         return response()->json([
//             'success' => true,
//             'message' => 'Đã xóa tất cả sản phẩm trong giỏ hàng'
//         ]);
//     }

//     /**
//      * Lấy số lượng items trong giỏ
//      */
//     public function count()
//     {
//         $count = CartItem::where('user_id', Auth::id())->sum('quantity');

//         return response()->json([
//             'success' => true,
//             'count' => $count
//         ]);
//     }
// }